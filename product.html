<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ìˆ™ - ìƒí’ˆ ìƒì„¸</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://via.placeholder.com">
    <link rel="dns-prefetch" href="https://via.placeholder.com">
</head>

<body>
    <header>
        <a href="index.html" class="logo">
            <h1>ì¸ìˆ–</h1>
        </a>
        <nav>
            <a href="index.html">í™ˆ</a>
            <a href="ai-fit.html" class="ai-fit-link">ğŸ¤– AI í•</a>
            <a href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
            <a href="orders.html">ì£¼ë¬¸ë‚´ì—­</a>
            <a href="support.html">ê³ ê°ì„¼í„°</a>
            <a href="wishlist.html" class="wishlist-link">â¤ï¸ ì°œ</a>
            <a href="cart.html">ì¥ë°”êµ¬ë‹ˆ</a>
            <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
        </nav>
    </header>
    <main>
        <section id="product-detail">
            <div class="product-gallery">
                <img src="" alt="Product Image" id="main-image">
            </div>

            <div class="product-info">
                <h2 id="product-name">ìƒí’ˆ ì´ë¦„</h2>
                <p id="product-price">â‚©0</p>
                <p id="product-category" style="color: #666; margin: 0.5rem 0;">ì¹´í…Œê³ ë¦¬</p>
                <p id="product-description">ìƒí’ˆ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>

                <!-- ìƒ‰ìƒ ì„ íƒ -->
                <div class="color-selection" id="color-selection-container" style="display: none;">
                    <label><strong>ìƒ‰ìƒ ì„ íƒ:</strong></label>
                    <div id="color-options" class="color-options">
                        <!-- ìƒ‰ìƒ ì˜µì…˜ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- ì‚¬ì´ì¦ˆ ì„ íƒ -->
                <div class="size-selection">
                    <label for="product-size"><strong>ì‚¬ì´ì¦ˆ ì„ íƒ:</strong></label>
                    <select id="product-size" required>
                        <option value="">ì‚¬ì´ì¦ˆë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                    <a href="ai-fit.html" class="ai-fit-recommendation">
                        ğŸ¤– ë‚´ ì‚¬ì´ì¦ˆ ì°¾ê¸° (AI ì¶”ì²œ)
                    </a>
                    <div id="stock-info" style="margin-top: 10px; color: #666; font-size: 14px;"></div>
                </div>

                <!-- ìˆ˜ëŸ‰ ì„ íƒ -->
                <div class="quantity-selection">
                    <label for="product-quantity"><strong>ìˆ˜ëŸ‰:</strong></label>
                    <div class="quantity-controls">
                        <button type="button" class="qty-btn" onclick="decreaseQuantity()">-</button>
                        <input type="number" id="product-quantity" value="1" min="1" max="99" readonly>
                        <button type="button" class="qty-btn" onclick="increaseQuantity()">+</button>
                    </div>
                </div>

                <!-- ì´ ê°€ê²© -->
                <div class="total-price-display">
                    <span>ì´ ê¸ˆì•¡:</span>
                    <span id="total-price" class="total-price-value">â‚©0</span>
                </div>

                <button id="add-to-cart-btn">ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€</button>
            </div>
        </section>

        <!-- Product Details Tabs -->
        <section id="product-details-tabs">
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('detail')">ìƒì„¸ì •ë³´</button>
                <button class="tab-btn" onclick="switchTab('reviews')">ë¦¬ë·°</button>
                <button class="tab-btn" onclick="switchTab('shipping')">ë°°ì†¡/ë°˜í’ˆ</button>
                <button class="tab-btn" onclick="switchTab('qna')">Q&A</button>
            </div>

            <!-- ìƒì„¸ì •ë³´ íƒ­ -->
            <div id="tab-detail" class="tab-content active">
                <div class="detail-section">
                    <h3>ğŸ“¦ ìƒí’ˆ ìƒì„¸</h3>
                    <div id="product-detail-info">
                        <p>ì´ ì œí’ˆì€ ê³ í’ˆì§ˆ ì†Œì¬ë¡œ ì œì‘ë˜ì–´ í¸ì•ˆí•œ ì°©ìš©ê°ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>ğŸ“ ì‚¬ì´ì¦ˆ ì •ë³´</h3>
                    <table class="size-table" id="size-guide-table">
                        <thead>
                            <tr>
                                <th>ì‚¬ì´ì¦ˆ</th>
                                <th>ì´ì¥(cm)</th>
                                <th>ì–´ê¹¨(cm)</th>
                                <th>ê°€ìŠ´(cm)</th>
                                <th>ì†Œë§¤(cm)</th>
                            </tr>
                        </thead>
                        <tbody id="size-table-body">
                            <!-- ì‚¬ì´ì¦ˆ ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                    <p style="color: #666; font-size: 0.9em; margin-top: 10px;">â€» ì¸¡ì • ë°©ë²•ì— ë”°ë¼ 1~3cm ì˜¤ì°¨ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>

                <div class="detail-section">
                    <h3>ğŸ§µ ì†Œì¬ ë° ê´€ë¦¬</h3>
                    <div id="material-care-info">
                        <p><strong>ì†Œì¬:</strong> <span id="material-info">ë©´ 100%</span></p>
                        <p><strong>ì„¸íƒë°©ë²•:</strong></p>
                        <ul>
                            <li>ì°¬ë¬¼ ë˜ëŠ” ë¯¸ì§€ê·¼í•œ ë¬¼ë¡œ ì„¸íƒ</li>
                            <li>ì¤‘ì„±ì„¸ì œ ì‚¬ìš©</li>
                            <li>ì‚¶ê±°ë‚˜ í‘œë°±ì œ ì‚¬ìš© ê¸ˆì§€</li>
                            <li>ê±´ì¡°ê¸° ì‚¬ìš© ê¸ˆì§€</li>
                            <li>ê·¸ëŠ˜ì—ì„œ ê±´ì¡°</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- ë¦¬ë·° íƒ­ -->
            <div id="tab-reviews" class="tab-content">
                <!-- ê¸°ì¡´ ë¦¬ë·° ì„¹ì…˜ì´ ì—¬ê¸°ë¡œ ì´ë™ë©ë‹ˆë‹¤ -->
            </div>

            <!-- ë°°ì†¡/ë°˜í’ˆ íƒ­ -->
            <div id="tab-shipping" class="tab-content">
                <div class="detail-section">
                    <h3>ğŸšš ë°°ì†¡ ì•ˆë‚´</h3>
                    <p><strong>ë°°ì†¡ë¹„:</strong> 3,000ì› (50,000ì› ì´ìƒ êµ¬ë§¤ ì‹œ ë¬´ë£Œ)</p>
                    <p><strong>ë°°ì†¡ê¸°ê°„:</strong> ì£¼ë¬¸ í›„ 2-3ì¼ ì†Œìš” (ì£¼ë§/ê³µíœ´ì¼ ì œì™¸)</p>
                    <p><strong>ë°°ì†¡ì§€ì—­:</strong> ì „êµ­ (ì œì£¼/ë„ì„œì‚°ê°„ ì§€ì—­ ì¶”ê°€ë¹„ìš© ë°œìƒ)</p>
                </div>

                <div class="detail-section">
                    <h3>â†©ï¸ ë°˜í’ˆ/êµí™˜ ì•ˆë‚´</h3>
                    <p><strong>ë°˜í’ˆ/êµí™˜ ê°€ëŠ¥ ê¸°ê°„:</strong> ìƒí’ˆ ìˆ˜ë ¹ í›„ 7ì¼ ì´ë‚´</p>
                    <p><strong>ë°˜í’ˆ ë¶ˆê°€ ì‚¬ìœ :</strong></p>
                    <ul>
                        <li>ìƒí’ˆ íƒ(tag) ì œê±° ë˜ëŠ” ë¼ë²¨ì´ í›¼ì†ëœ ê²½ìš°</li>
                        <li>ì°©ìš© í›„ ì„¸íƒí•œ ê²½ìš°</li>
                        <li>ê³ ê°ë‹˜ì˜ ë‹¨ìˆœ ë³€ì‹¬ìœ¼ë¡œ ì¸í•œ ê²½ìš° (ì™•ë³µ ë°°ì†¡ë¹„ ê³ ê° ë¶€ë‹´)</li>
                        <li>ìƒí’ˆ í›¼ì† ë° ì˜¤ì—¼ëœ ê²½ìš°</li>
                    </ul>
                    <p><strong>ë°˜í’ˆ ë°°ì†¡ë¹„:</strong> í¸ë„ 3,000ì› / ì™•ë³µ 6,000ì›</p>
                </div>
            </div>

            <!-- Q&A íƒ­ -->
            <div id="tab-qna" class="tab-content">
                <div class="detail-section">
                    <h3>ğŸ’¬ ìƒí’ˆ ë¬¸ì˜</h3>
                    <p>ìƒí’ˆì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹ ê°€ìš”?</p>
                    <button class="btn-primary" onclick="window.location.href='support.html'">ë¬¸ì˜í•˜ê¸°</button>
                </div>
            </div>
        </section>

        <!-- Reviews Section (ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì œê±°í•˜ê³  íƒ­ ì•ˆìœ¼ë¡œ ì´ë™ë  ì˜ˆì •) -->
        <section id="reviews-section" style="display: none;">
            <div class="reviews-header">
                <h2>ìƒí’ˆ ë¦¬ë·°</h2>
                <div class="review-filter-buttons">
                    <button class="filter-btn active" onclick="filterReviews('all')">ì „ì²´ ë¦¬ë·°</button>
                    <button class="filter-btn" onclick="filterReviews('photo')">ğŸ“· í¬í†  ë¦¬ë·°</button>
                    <button class="filter-btn" onclick="filterReviews('high')">â­ ë†’ì€ í‰ì </button>
                </div>
            </div>
            <div id="photo-reviews-highlight" class="photo-reviews-section">
                <!-- Photo reviews will be highlighted here -->
            </div>
            <div id="reviews-list">
                <!-- Reviews will be loaded here -->
            </div>

            <div id="review-form-container">
                <h3>ë¦¬ë·° ì‘ì„±í•˜ê¸°</h3>
                <form id="review-form">
                    <label for="reviewer-name">ì´ë¦„:</label>
                    <input type="text" id="reviewer-name" required>

                    <label for="review-rating">í‰ì :</label>
                    <select id="review-rating" required>
                        <option value="5">â­â­â­â­â­ (5ì )</option>
                        <option value="4">â­â­â­â­ (4ì )</option>
                        <option value="3">â­â­â­ (3ì )</option>
                        <option value="2">â­â­ (2ì )</option>
                        <option value="1">â­ (1ì )</option>
                    </select>

                    <label for="review-text">ë¦¬ë·° ë‚´ìš©:</label>
                    <textarea id="review-text" rows="4" required></textarea>

                    <label for="review-images">ğŸ“· ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ, ìµœëŒ€ 3ì¥):</label>
                    <input type="file" id="review-images" accept="image/*" multiple>
                    <div id="image-preview" class="image-preview-container"></div>
                    <p class="image-info">ğŸ’¡ í¬í†  ë¦¬ë·° ì‘ì„± ì‹œ ë” ë§ì€ ì‚¬ìš©ìì—ê²Œ ë„ì›€ì´ ë©ë‹ˆë‹¤!</p>

                    <button type="button" onclick="submitReview()">ë¦¬ë·° ë“±ë¡</button>
                </form>
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 ì¸ìˆ–. All rights reserved.</p>
    </footer>

    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
    <div id="toast" class="toast"></div>

    <script src="main.js"></script>
    <script>
        // ìƒ‰ìƒ ì½”ë“œ ë§¤í•‘ í•¨ìˆ˜
        function getColorCode(colorName) {
            const colorMap = {
                'í™”ì´íŠ¸': '#FFFFFF',
                'ì•„ì´ë³´ë¦¬': '#FFFFF0',
                'ë¸”ë™': '#000000',
                'ë„¤ì´ë¹„': '#000080',
                'ê·¸ë ˆì´': '#808080',
                'ë² ì´ì§€': '#F5F5DC',
                'ë¸”ë£¨': '#0000FF',
                'í•‘í¬': '#FFC0CB',
                'ì¹´í‚¤': '#F0E68C',
                'ë¸Œë¼ìš´': '#8B4513',
                'ë¼ì´íŠ¸ë¸”ë£¨': '#ADD8E6',
                'ì¹´ë©œ': '#C19A6B'
            };
            return colorMap[colorName] || '#CCCCCC';
        }

        // íƒ­ ì „í™˜ í•¨ìˆ˜
        function switchTab(tabName) {
            // ëª¨ë“  íƒ­ ë²„íŠ¼ê³¼ ì»¨í…ì¸  ë¹„í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // ì„ íƒëœ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');

            // ë¦¬ë·° íƒ­ ì„ íƒ ì‹œ ë¦¬ë·° ì„¹ì…˜ ì´ë™
            if (tabName === 'reviews') {
                const reviewsSection = document.getElementById('reviews-section');
                const tabReviews = document.getElementById('tab-reviews');
                if (reviewsSection && tabReviews) {
                    tabReviews.innerHTML = reviewsSection.innerHTML;
                    reviewsSection.style.display = 'none';
                }
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¦¬ë·° ì„¹ì…˜ì„ íƒ­ ì•ˆìœ¼ë¡œ ì´ë™
        document.addEventListener('DOMContentLoaded', function () {
            const reviewsSection = document.getElementById('reviews-section');
            const tabReviews = document.getElementById('tab-reviews');
            if (reviewsSection && tabReviews) {
                tabReviews.innerHTML = reviewsSection.innerHTML;
                reviewsSection.style.display = 'none';
            }
        });

        // ì¹´íŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            const totalItems = cart.reduce((sum, item) => sum + (parseInt(item.qty) || parseInt(item.quantity) || 0), 0);
            const countElement = document.getElementById('cart-count');
            if (countElement) {
                if (totalItems > 0) {
                    countElement.classList.add('has-items');
                } else {
                    countElement.classList.remove('has-items');
                }
            }
        }

        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = parseInt(urlParams.get('id'));
        let currentProduct = null;

        // ì‚¬ì´ì¦ˆ ì˜µì…˜ ì„¤ì •
        const SIZE_OPTIONS = {
            'TOPS': ['S', 'M', 'L', 'XL', 'XXL'],
            'PANTS': ['28', '29', '30', '31', '32', '33', '34', '36'],
            'OUTER': ['S', 'M', 'L', 'XL', 'XXL'],
            'SHOES': ['240', '245', '250', '255', '260', '265', '270', '275', '280', '285', '290']
        };

        // ìˆ˜ëŸ‰ ì¦ê°€/ê°ì†Œ
        function increaseQuantity() {
            const qtyInput = document.getElementById('product-quantity');
            const currentQty = parseInt(qtyInput.value);
            if (currentQty < 99) {
                qtyInput.value = currentQty + 1;
                updateTotalPrice();
            }
        }

        function decreaseQuantity() {
            const qtyInput = document.getElementById('product-quantity');
            const currentQty = parseInt(qtyInput.value);
            if (currentQty > 1) {
                qtyInput.value = currentQty - 1;
                updateTotalPrice();
            }
        }

        // ì´ ê°€ê²© ì—…ë°ì´íŠ¸
        function updateTotalPrice() {
            if (currentProduct) {
                const quantity = parseInt(document.getElementById('product-quantity').value);
                const totalPrice = currentProduct.price * quantity;
                document.getElementById('total-price').textContent = `â‚©${totalPrice.toLocaleString()}`;
            }
        }

        // ì‚¬ì´ì¦ˆ ì˜µì…˜ ë¡œë“œ í•¨ìˆ˜ (ìƒ‰ìƒ ë³€ê²½ ì‹œ ì¬í˜¸ì¶œ)
        function loadSizeOptions() {
            if (!currentProduct) return;

            const sizeSelect = document.getElementById('product-size');
            const stock = window.getProductStock ? window.getProductStock(currentProduct.id) : currentProduct.stock;

            // ì„ íƒëœ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
            const selectedColorBtn = document.querySelector('.color-option-btn.selected');
            const selectedColor = selectedColorBtn ? selectedColorBtn.getAttribute('data-color') : null;

            let sizes = [];
            let colorStock = stock;
            let isColorBasedStock = false;

            // ì¬ê³  êµ¬ì¡° í™•ì¸
            const stockKeys = Object.keys(stock);
            if (stockKeys.length > 0) {
                const firstKey = stockKeys[0];
                const firstValue = stock[firstKey];

                if (typeof firstValue === 'object' && firstValue !== null && !Array.isArray(firstValue)) {
                    isColorBasedStock = true;
                }
            }

            // ìƒ‰ìƒë³„ ì¬ê³  êµ¬ì¡° í™•ì¸
            if (selectedColor && stock[selectedColor]) {
                // ì„ íƒëœ ìƒ‰ìƒì˜ ì¬ê³ 
                colorStock = stock[selectedColor];
                sizes = Object.keys(colorStock);
            } else if (selectedColor) {
                // ìƒ‰ìƒì€ ì„ íƒí–ˆì§€ë§Œ ì¬ê³ ê°€ ì—†ëŠ” ê²½ìš°
                sizes = [];
            } else {
                if (isColorBasedStock) {
                    // ìƒ‰ìƒë³„-ì‚¬ì´ì¦ˆë³„ êµ¬ì¡° - ëª¨ë“  ì‚¬ì´ì¦ˆ ìˆ˜ì§‘
                    const allSizesSet = new Set();
                    Object.values(stock).forEach(colorStockData => {
                        Object.keys(colorStockData).forEach(size => allSizesSet.add(size));
                    });
                    sizes = Array.from(allSizesSet);
                } else {
                    // ê¸°ì¡´ ì‚¬ì´ì¦ˆë³„ êµ¬ì¡°
                    sizes = stockKeys;
                }
            }

            sizeSelect.innerHTML = '<option value="">ì‚¬ì´ì¦ˆë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            sizes.forEach(size => {
                const option = document.createElement('option');
                option.value = size;

                let totalStockQty = 0;

                // ì¬ê³  ê³„ì‚°
                if (selectedColor && stock[selectedColor]) {
                    // íŠ¹ì • ìƒ‰ìƒ ì„ íƒëœ ê²½ìš°
                    totalStockQty = stock[selectedColor][size] || 0;
                } else if (isColorBasedStock) {
                    // ìƒ‰ìƒë³„ êµ¬ì¡° - ëª¨ë“  ìƒ‰ìƒì˜ í•´ë‹¹ ì‚¬ì´ì¦ˆ ì¬ê³  í•©ì‚°
                    Object.values(stock).forEach(colorStockData => {
                        if (colorStockData[size] !== undefined) {
                            totalStockQty += colorStockData[size];
                        }
                    });
                } else {
                    // ê¸°ì¡´ êµ¬ì¡°
                    totalStockQty = stock[size] || 0;
                }

                if (totalStockQty === 0) {
                    option.textContent = `${size} (í’ˆì ˆ)`;
                    option.disabled = true;
                    option.style.color = '#999';
                } else if (totalStockQty < 5) {
                    option.textContent = `${size} (ì¬ê³ : ${totalStockQty}ê°œ)`;
                } else {
                    option.textContent = size;
                }

                sizeSelect.appendChild(option);
            });

            // ì¬ê³  ì •ë³´ ì´ˆê¸°í™”
            document.getElementById('stock-info').innerHTML = '';
        }

        // Load product details
        function loadProductDetails() {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) {
                alert("ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                window.location.href = "index.html";
                return;
            }

            currentProduct = product;

            document.getElementById('main-image').src = product.image;
            document.getElementById('product-name').textContent = product.name;
            document.getElementById('product-price').textContent = `â‚©${product.price.toLocaleString()}`;
            document.getElementById('product-category').textContent = `ì¹´í…Œê³ ë¦¬: ${product.category}`;
            document.getElementById('product-description').textContent = `${product.name}ì˜ ìƒì„¸ ì„¤ëª…ì…ë‹ˆë‹¤.`;

            // ìƒ‰ìƒ ì˜µì…˜ ì¶”ê°€
            if (product.colors && product.colors.length > 0) {
                const colorContainer = document.getElementById('color-selection-container');
                const colorOptions = document.getElementById('color-options');
                colorContainer.style.display = 'block';

                colorOptions.innerHTML = '';
                product.colors.forEach((color, index) => {
                    const colorBtn = document.createElement('button');
                    colorBtn.className = 'color-option-btn';
                    if (index === 0) colorBtn.classList.add('selected');
                    colorBtn.setAttribute('data-color', color);
                    colorBtn.innerHTML = `
                        <span class="color-preview" style="background-color: ${getColorCode(color)};"></span>
                        <span class="color-name">${color}</span>
                    `;
                    colorBtn.onclick = function () {
                        document.querySelectorAll('.color-option-btn').forEach(btn => btn.classList.remove('selected'));
                        this.classList.add('selected');
                        // ìƒ‰ìƒ ë³€ê²½ ì‹œ ì‚¬ì´ì¦ˆ ì˜µì…˜ ë‹¤ì‹œ ë¡œë“œ
                        loadSizeOptions();
                    };
                    colorOptions.appendChild(colorBtn);
                });

                // ìƒ‰ìƒ ë²„íŠ¼ì´ ëª¨ë‘ ì¶”ê°€ëœ í›„ ì‚¬ì´ì¦ˆ ì˜µì…˜ ë¡œë“œ
                setTimeout(() => loadSizeOptions(), 10);
            } else {
                // ìƒ‰ìƒì´ ì—†ëŠ” ê²½ìš°ì—ë„ ì‚¬ì´ì¦ˆ ì˜µì…˜ ë¡œë“œ
                loadSizeOptions();
            }

            // ì‚¬ì´ì¦ˆ ì„ íƒ ì‹œ ì¬ê³  ì •ë³´ í‘œì‹œ
            const sizeSelect = document.getElementById('product-size');
            sizeSelect.addEventListener('change', function () {
                const selectedSize = this.value;
                const stockInfo = document.getElementById('stock-info');
                const stock = window.getProductStock ? window.getProductStock(product.id) : product.stock;

                // ì„ íƒëœ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
                const selectedColorBtn = document.querySelector('.color-option-btn.selected');
                const selectedColor = selectedColorBtn ? selectedColorBtn.getAttribute('data-color') : null;

                if (selectedSize) {
                    let stockQty = 0;

                    // ì¬ê³  êµ¬ì¡° í™•ì¸
                    const firstKey = Object.keys(stock)[0];
                    const isColorBasedStock = firstKey && typeof stock[firstKey] === 'object' && !Array.isArray(stock[firstKey]);

                    // ìƒ‰ìƒë³„ ì¬ê³  í™•ì¸
                    if (selectedColor && stock[selectedColor]) {
                        stockQty = stock[selectedColor][selectedSize] || 0;
                    } else if (isColorBasedStock) {
                        // ëª¨ë“  ìƒ‰ìƒì˜ í•´ë‹¹ ì‚¬ì´ì¦ˆ ì¬ê³  í•©ì‚°
                        Object.values(stock).forEach(colorStockData => {
                            if (colorStockData[selectedSize] !== undefined) {
                                stockQty += colorStockData[selectedSize];
                            }
                        });
                    } else {
                        stockQty = stock[selectedSize] || 0;
                    }

                    if (stockQty === 0) {
                        stockInfo.innerHTML = '<span style="color: red;">âŒ í’ˆì ˆëœ ìƒí’ˆì…ë‹ˆë‹¤.</span>';
                        document.getElementById('add-to-cart-btn').disabled = true;
                    } else if (stockQty < 5) {
                        stockInfo.innerHTML = `<span style="color: orange;">âš ï¸ ë‚¨ì€ ì¬ê³ : ${stockQty}ê°œ</span>`;
                        document.getElementById('add-to-cart-btn').disabled = false;
                        document.getElementById('product-quantity').max = stockQty;
                    } else {
                        stockInfo.innerHTML = '<span style="color: green;">âœ… êµ¬ë§¤ ê°€ëŠ¥</span>';
                        document.getElementById('add-to-cart-btn').disabled = false;
                        document.getElementById('product-quantity').max = Math.min(99, stockQty);
                    }
                } else {
                    stockInfo.innerHTML = '';
                    document.getElementById('add-to-cart-btn').disabled = false;
                }
            });

            // ì‚¬ì´ì¦ˆ ë³€ê²½ ì‹œ AI ì¶”ì²œ í‘œì‹œ
            const savedAnalysis = localStorage.getItem('bodyAnalysis');
            if (savedAnalysis) {
                const analysis = JSON.parse(savedAnalysis);
                let recommendedSize = '';

                if (product.category === 'TOPS') {
                    recommendedSize = analysis.topSize?.size || '';
                } else if (product.category === 'PANTS') {
                    recommendedSize = analysis.bottomSize?.size + '' || '';
                } else if (product.category === 'OUTER') {
                    recommendedSize = analysis.outerSize?.size || '';
                } else if (product.category === 'SHOES') {
                    recommendedSize = analysis.shoeSize?.size + '' || '';
                }

                if (recommendedSize) {
                    // ì¶”ì²œ ì‚¬ì´ì¦ˆ í‘œì‹œ
                    const fitRecommendation = document.querySelector('.ai-fit-recommendation');
                    if (fitRecommendation) {
                        fitRecommendation.innerHTML = `ğŸ¤– AI ì¶”ì²œ ì‚¬ì´ì¦ˆ: <strong>${recommendedSize}</strong>`;
                        fitRecommendation.style.color = '#667eea';
                    }
                }
            }

            // ì´ˆê¸° ì´ ê°€ê²© ì„¤ì •
            updateTotalPrice();

            // Add to cart button
            document.getElementById('add-to-cart-btn').addEventListener('click', function () {
                // ë¡œê·¸ì¸ ì²´í¬
                if (!window.isLoggedIn || !window.isLoggedIn()) {
                    alert('ì¥ë°”êµ¬ë‹ˆëŠ” ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = 'login.html?return=' + encodeURIComponent(window.location.pathname + window.location.search);
                    return;
                }

                const size = document.getElementById('product-size').value;
                const quantity = parseInt(document.getElementById('product-quantity').value);

                // ì„ íƒëœ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
                const selectedColorBtn = document.querySelector('.color-option-btn.selected');
                const selectedColor = selectedColorBtn ? selectedColorBtn.getAttribute('data-color') : null;

                if (!size) {
                    alert('ì‚¬ì´ì¦ˆë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                    return;
                }

                if (quantity < 1) {
                    alert('ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”!');
                    return;
                }

                addToCartWithOptions(currentProduct, size, quantity, selectedColor);
            });
        }

        // ì˜µì…˜ í¬í•¨ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€
        function addToCartWithOptions(product, size, quantity, color) {
            // ì¬ê³  í™•ì¸ (ìƒ‰ìƒ í¬í•¨)
            if (window.checkStock && !window.checkStock(product.id, size, quantity, color)) {
                alert('ì„ íƒí•œ ìƒ‰ìƒ/ì‚¬ì´ì¦ˆì˜ ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                return;
            }

            let cart = JSON.parse(localStorage.getItem("cart")) || [];

            // ê°™ì€ ìƒí’ˆ, ê°™ì€ ì‚¬ì´ì¦ˆ, ê°™ì€ ìƒ‰ìƒì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
            const existingItemIndex = cart.findIndex(item =>
                item.id === product.id && item.size === size && item.color === color
            );

            if (existingItemIndex > -1) {
                // ì´ë¯¸ ìˆìœ¼ë©´ ìˆ˜ëŸ‰ë§Œ ì¦ê°€
                cart[existingItemIndex].quantity += quantity;
            } else {
                // ìƒˆë¡œìš´ í•­ëª© ì¶”ê°€
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: product.image,
                    category: product.category,
                    size: size,
                    color: color,
                    quantity: quantity
                });
            }

            localStorage.setItem("cart", JSON.stringify(cart));

            const colorText = color ? `, ìƒ‰ìƒ: ${color}` : '';
            showToast(`${product.name} (ì‚¬ì´ì¦ˆ: ${size}${colorText}, ìˆ˜ëŸ‰: ${quantity}ê°œ)ê°€ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ›’`);
            updateCartCount();

            // ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í• ì§€ ë¬»ê¸°
            setTimeout(() => {
                if (confirm('ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    window.location.href = 'cart.html';
                }
            }, 500);
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë° íŒŒì¼ ê´€ë¦¬
        let selectedImages = [];

        document.getElementById('review-images')?.addEventListener('change', function (e) {
            const files = Array.from(e.target.files).slice(0, 3); // ìµœëŒ€ 3ê°œ
            const previewContainer = document.getElementById('image-preview');
            previewContainer.innerHTML = '';
            selectedImages = [];

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (event) {
                    selectedImages.push(event.target.result);

                    const imgWrapper = document.createElement('div');
                    imgWrapper.className = 'preview-image-wrapper';
                    imgWrapper.innerHTML = `
                        <img src="${event.target.result}" alt="Preview ${index + 1}">
                        <button type="button" class="remove-image-btn" onclick="removeImage(${index})">&times;</button>
                    `;
                    previewContainer.appendChild(imgWrapper);
                };
                reader.readAsDataURL(file);
            });
        });

        function removeImage(index) {
            selectedImages.splice(index, 1);
            const fileInput = document.getElementById('review-images');
            fileInput.value = '';

            const previewContainer = document.getElementById('image-preview');
            previewContainer.innerHTML = '';
            selectedImages.forEach((imgSrc, idx) => {
                const imgWrapper = document.createElement('div');
                imgWrapper.className = 'preview-image-wrapper';
                imgWrapper.innerHTML = `
                    <img src="${imgSrc}" alt="Preview ${idx + 1}">
                    <button type="button" class="remove-image-btn" onclick="removeImage(${idx})">&times;</button>
                `;
                previewContainer.appendChild(imgWrapper);
            });
        }

        // Load reviews for this product
        function loadReviews(filter = 'all') {
            const allReviews = JSON.parse(localStorage.getItem(`reviews_${productId}`)) || [];
            let reviews = [...allReviews];

            // í•„í„° ì ìš©
            if (filter === 'photo') {
                reviews = reviews.filter(r => r.images && r.images.length > 0);
            } else if (filter === 'high') {
                reviews = reviews.filter(r => r.rating >= 4);
            }

            const reviewsList = document.getElementById('reviews-list');
            const photoHighlight = document.getElementById('photo-reviews-highlight');

            // í¬í†  ë¦¬ë·° í•˜ì´ë¼ì´íŠ¸ ì„¹ì…˜
            const photoReviews = allReviews.filter(r => r.images && r.images.length > 0).slice(0, 3);
            if (photoReviews.length > 0 && filter === 'all') {
                photoHighlight.innerHTML = `
                    <h3>ğŸ“¸ í¬í†  ë¦¬ë·°</h3>
                    <div class="photo-reviews-grid">
                        ${photoReviews.map((review, idx) => `
                            <div class="photo-review-card" onclick="scrollToReview('review-${allReviews.indexOf(review)}')">
                                <img src="${review.images[0]}" alt="Photo review">
                                <div class="photo-review-overlay">
                                    <span class="review-rating">${'â­'.repeat(review.rating)}</span>
                                    <p class="review-author">${review.name}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                photoHighlight.style.display = 'block';
            } else {
                photoHighlight.style.display = 'none';
            }

            reviewsList.innerHTML = "";

            if (reviews.length === 0) {
                reviewsList.innerHTML = "<p>ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>";
                return;
            }

            reviews.forEach((review, index) => {
                const actualIndex = allReviews.indexOf(review);
                const reviewDiv = document.createElement('div');
                reviewDiv.className = 'review-item';
                reviewDiv.id = `review-${actualIndex}`;
                const stars = 'â­'.repeat(review.rating);

                const imagesHtml = review.images && review.images.length > 0
                    ? `<div class="review-images">
                        ${review.images.map(img => `
                            <img src="${img}" alt="Review image" onclick="openImageModal('${img}')">
                        `).join('')}
                       </div>`
                    : '';

                reviewDiv.innerHTML = `
                    <div class="review-header">
                        <h4>${review.name} <span class="review-rating">${stars}</span>
                        ${review.images && review.images.length > 0 ? '<span class="photo-badge">ğŸ“¸ í¬í† ë¦¬ë·°</span>' : ''}
                        </h4>
                        <div class="review-actions">
                            <button class="edit-review-btn" onclick="editReview(${actualIndex})">ìˆ˜ì •</button>
                            <button class="delete-review-btn" onclick="deleteReview(${actualIndex})">ì‚­ì œ</button>
                        </div>
                    </div>
                    <p class="review-date">${review.date}</p>
                    ${imagesHtml}
                    <p class="review-text">${review.text}</p>
                `;
                reviewsList.appendChild(reviewDiv);
            });
        }

        function filterReviews(type) {
            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadReviews(type);
        }

        function scrollToReview(reviewId) {
            document.getElementById(reviewId).scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById(reviewId).classList.add('highlight-review');
            setTimeout(() => {
                document.getElementById(reviewId).classList.remove('highlight-review');
            }, 2000);
        }

        function openImageModal(imgSrc) {
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="image-modal-content">
                    <span class="close-modal" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <img src="${imgSrc}" alt="Full size image">
                </div>
            `;
            modal.onclick = function (e) {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }

        // Delete review
        function deleteReview(index) {
            if (!confirm('ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            const reviews = JSON.parse(localStorage.getItem(`reviews_${productId}`)) || [];
            reviews.splice(index, 1);
            localStorage.setItem(`reviews_${productId}`, JSON.stringify(reviews));
            loadReviews();
            alert('ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // Edit review
        function editReview(index) {
            const reviews = JSON.parse(localStorage.getItem(`reviews_${productId}`)) || [];
            const review = reviews[index];

            // Fill form with existing review data
            document.getElementById('reviewer-name').value = review.name;
            document.getElementById('review-rating').value = review.rating;
            document.getElementById('review-text').value = review.text;

            // ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ
            if (review.images && review.images.length > 0) {
                selectedImages = [...review.images];
                const previewContainer = document.getElementById('image-preview');
                previewContainer.innerHTML = '';
                review.images.forEach((imgSrc, idx) => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.className = 'preview-image-wrapper';
                    imgWrapper.innerHTML = `
                        <img src="${imgSrc}" alt="Preview ${idx + 1}">
                        <button type="button" class="remove-image-btn" onclick="removeImage(${idx})">&times;</button>
                    `;
                    previewContainer.appendChild(imgWrapper);
                });
            }

            // Change form to edit mode
            const submitBtn = document.querySelector('#review-form button[type="submit"]');
            submitBtn.textContent = 'ë¦¬ë·° ìˆ˜ì •';
            submitBtn.dataset.editIndex = index;

            // Scroll to form
            document.getElementById('review-form-container').scrollIntoView({ behavior: 'smooth' });
        }

        // ë¦¬ë·° ì œì¶œ í•¨ìˆ˜
        function submitReview() {
            if (!productId || isNaN(productId)) {
                alert('ìƒí’ˆ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                return;
            }

            const name = document.getElementById('reviewer-name').value;
            const rating = parseInt(document.getElementById('review-rating').value);
            const text = document.getElementById('review-text').value;
            const submitBtn = document.querySelector('#review-form button');
            const editIndex = submitBtn.dataset.editIndex;

            if (!name || !text) {
                alert('ì´ë¦„ê³¼ ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const reviews = JSON.parse(localStorage.getItem(`reviews_${productId}`)) || [];

            const reviewData = {
                name: name,
                rating: rating,
                text: text,
                images: selectedImages.length > 0 ? selectedImages : undefined,
                date: editIndex !== undefined ? reviews[editIndex].date : new Date().toLocaleDateString('ko-KR')
            };

            if (editIndex !== undefined) {
                // Update existing review
                reviews[editIndex] = reviewData;
                alert('ë¦¬ë·°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');

                // Reset form to add mode
                submitBtn.textContent = 'ë¦¬ë·° ë“±ë¡';
                delete submitBtn.dataset.editIndex;
            } else {
                // Add new review
                reviews.push(reviewData);
                alert('ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!' + (selectedImages.length > 0 ? ' ğŸ“¸ í¬í† ë¦¬ë·° ê°ì‚¬í•©ë‹ˆë‹¤!' : ''));
            }

            localStorage.setItem(`reviews_${productId}`, JSON.stringify(reviews));

            // Clear form
            document.getElementById('review-form').reset();
            document.getElementById('image-preview').innerHTML = '';
            selectedImages = [];

            // Reload reviews
            loadReviews();
        }

        // Handle review form submission
        document.getElementById('review-form')?.addEventListener('submit', function (e) {
            e.preventDefault();
            e.stopPropagation();
            submitReview();
            return false;
        });

        // Load theme on page load
        function loadTheme() {
            const isDark = localStorage.getItem('theme') === 'dark';
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-toggle').textContent = 'â˜€ï¸';
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-toggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // Load on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadTheme();
            loadProductDetails();
            loadReviews();
        });
    </script>
    <script src="performance.js"></script>
    <script>
        // ì´ë¯¸ì§€ ì••ì¶• ì ìš©
        document.addEventListener('DOMContentLoaded', () => {
            const imageInput = document.getElementById('review-images');
            if (imageInput) {
                imageInput.addEventListener('change', async (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length > 3) {
                        alert('ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 3ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                        return;
                    }

                    // ì´ë¯¸ì§€ ì••ì¶•
                    const compressor = new ImageCompressor();
                    const compressed = [];

                    for (const file of files) {
                        try {
                            const compressedImage = await compressor.compress(file);
                            compressed.push(compressedImage);
                        } catch (error) {
                            console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨:', error);
                        }
                    }

                    // ì••ì¶•ëœ ì´ë¯¸ì§€ë¡œ selectedImages êµì²´
                    if (window.selectedImages) {
                        window.selectedImages = compressed;
                        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                        if (window.displayImagePreviews) {
                            window.displayImagePreviews();
                        }
                    }
                });
            }
        });
    </script>
</body>

</html>