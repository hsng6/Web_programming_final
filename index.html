<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ìˆ–</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <a href="index.html" class="logo">
            <h1>ì¸ìˆ–</h1>
        </a>
        <div class="search-container">
            <input type="text" id="search-input" placeholder="ìƒí’ˆ ê²€ìƒ‰...">
            <button id="search-btn">ê²€ìƒ‰</button>
        </div>
        <nav>
            <a href="index.html">í™ˆ</a>
            <a href="ai-fit.html" class="ai-fit-link">ğŸ¤– AI í•</a>
            <a href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
            <a href="orders.html">ì£¼ë¬¸ë‚´ì—­</a>
            <a href="support.html">ê³ ê°ì„¼í„°</a>
            <a href="cart.html" class="cart-link">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ <span id="cart-count">0</span></a>
        </nav>
    </header>
    <main>
        <!-- Category Navigation -->
        <nav id="category-nav">
            <button class="category-btn active" data-category="ALL">ì „ì²´</button>
            <button class="category-btn" data-category="TOPS">TOPS</button>
            <button class="category-btn" data-category="PANTS">PANTS</button>
            <button class="category-btn" data-category="OUTER">OUTER</button>
            <button class="category-btn" data-category="SHOES">SHOES</button>
            <button id="theme-toggle" class="theme-btn" title="ë‹¤í¬ëª¨ë“œ ì „í™˜">ğŸŒ™</button>
        </nav>

        <!-- Sort and Filter Bar -->
        <div class="sort-filter-bar">
            <div class="sort-options">
                <label>ì •ë ¬:</label>
                <select id="sort-select" onchange="sortProducts(this.value)">
                    <option value="default">ê¸°ë³¸ìˆœ</option>
                    <option value="price-low">ë‚®ì€ ê°€ê²©ìˆœ</option>
                    <option value="price-high">ë†’ì€ ê°€ê²©ìˆœ</option>
                    <option value="popular">ì¸ê¸°ìˆœ (ë¦¬ë·°ë§ì€ìˆœ)</option>
                    <option value="rating">í‰ì ìˆœ</option>
                </select>
            </div>
            <div class="view-options">
                <button onclick="window.location.href='wishlist.html'" class="wishlist-link">â¤ï¸ ì°œí•œìƒí’ˆ <span
                        id="wishlist-count">0</span></button>
            </div>
        </div>

        <!-- Products Section -->
        <section id="products-section">
            <h2 id="category-title">ì „ì²´ ìƒí’ˆ</h2>
            <div id="product-list" class="product-grid">
                <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ìƒí’ˆì„ ì¶”ê°€í•©ë‹ˆë‹¤ -->
            </div>
        </section>

        <!-- Recently Viewed Products -->
        <section id="recent-products-section" style="display: none;">
            <h2>ìµœê·¼ ë³¸ ìƒí’ˆ</h2>
            <div id="recent-products-list" class="product-grid-horizontal">
                <!-- Recently viewed products will be loaded here -->
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 ì¸ìˆ–. All rights reserved.</p>
    </footer>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="main.js"></script>
    <script>
        // Update cart count on page load
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
            document.getElementById('cart-count').textContent = totalItems;
        }

        document.addEventListener('DOMContentLoaded', function () {
            updateCartCount();
            updateWishlistCount();
            loadRecentProducts();
            loadTheme();
        });

        // Toast ì•Œë¦¼ í•¨ìˆ˜
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateWishlistCount() {
            const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
            const count = document.getElementById('wishlist-count');
            if (count) count.textContent = wishlist.length;
        }

        // ìµœê·¼ ë³¸ ìƒí’ˆ ë¡œë“œ
        function loadRecentProducts() {
            const recent = JSON.parse(localStorage.getItem('recentProducts')) || [];
            if (recent.length === 0) return;

            const section = document.getElementById('recent-products-section');
            const list = document.getElementById('recent-products-list');
            section.style.display = 'block';
            list.innerHTML = '';

            recent.slice(0, 5).forEach(productId => {
                const product = PRODUCTS.find(p => p.id === productId);
                if (!product) return;

                const card = document.createElement('div');
                card.className = 'product-card-small';
                card.onclick = function () { viewProduct(product.id); };
                card.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" loading="lazy">
                    <h4>${product.name}</h4>
                    <p>â‚©${product.price.toLocaleString()}</p>
                `;
                list.appendChild(card);
            });
        }

        // ë‹¤í¬ëª¨ë“œ í† ê¸€
        document.getElementById('theme-toggle')?.addEventListener('click', function () {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            this.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            showToast(isDark ? 'ë‹¤í¬ëª¨ë“œ í™œì„±í™”' : 'ë¼ì´íŠ¸ëª¨ë“œ í™œì„±í™”');
        });

        function loadTheme() {
            const theme = localStorage.getItem('theme');
            const toggle = document.getElementById('theme-toggle');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                if (toggle) toggle.textContent = 'â˜€ï¸';
            }
        }

        // ìƒí’ˆ ì •ë ¬
        function sortProducts(sortType) {
            let products = [...PRODUCTS];

            if (sortType === 'price-low') {
                products.sort((a, b) => a.price - b.price);
            } else if (sortType === 'price-high') {
                products.sort((a, b) => b.price - a.price);
            } else if (sortType === 'popular') {
                products.sort((a, b) => {
                    const reviewsA = JSON.parse(localStorage.getItem(`reviews_${a.id}`)) || [];
                    const reviewsB = JSON.parse(localStorage.getItem(`reviews_${b.id}`)) || [];
                    return reviewsB.length - reviewsA.length;
                });
            } else if (sortType === 'rating') {
                products.sort((a, b) => {
                    const reviewsA = JSON.parse(localStorage.getItem(`reviews_${a.id}`)) || [];
                    const reviewsB = JSON.parse(localStorage.getItem(`reviews_${b.id}`)) || [];
                    const avgA = reviewsA.length > 0 ? reviewsA.reduce((sum, r) => sum + r.rating, 0) / reviewsA.length : 0;
                    const avgB = reviewsB.length > 0 ? reviewsB.reduce((sum, r) => sum + r.rating, 0) / reviewsB.length : 0;
                    return avgB - avgA;
                });
            }

            renderSortedProducts(products);
        }

        function renderSortedProducts(products) {
            const productList = document.getElementById("product-list");
            const categoryTitle = document.getElementById("category-title");

            productList.innerHTML = "";
            categoryTitle.textContent = "ì •ë ¬ëœ ìƒí’ˆ";

            const reviewsCache = {};
            products.forEach(product => {
                const reviews = JSON.parse(localStorage.getItem(`reviews_${product.id}`)) || [];
                reviewsCache[product.id] = {
                    count: reviews.length,
                    average: reviews.length > 0
                        ? (reviews.reduce((sum, review) => sum + review.rating, 0) / reviews.length).toFixed(1)
                        : 0
                };
            });

            const fragment = document.createDocumentFragment();

            products.forEach(product => {
                const reviewData = reviewsCache[product.id];
                const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
                const isWished = wishlist.includes(product.id);

                const productCard = document.createElement("div");
                productCard.className = "product-card";
                productCard.onclick = function () { viewProduct(product.id); };
                productCard.innerHTML = `
                    <button class="wishlist-btn ${isWished ? 'active' : ''}" onclick="event.stopPropagation(); toggleWishlist(${product.id});" title="ì°œí•˜ê¸°">â¤ï¸</button>
                    <img src="${product.image}" alt="${product.name}" loading="lazy">
                    <h3>${product.name}</h3>
                    <p class="product-price">â‚©${product.price.toLocaleString()}</p>
                    <div class="product-review-info">
                        <span class="rating-stars">${'â­'.repeat(Math.round(reviewData.average))}</span>
                        <span class="rating-text">${reviewData.average} (${reviewData.count})</span>
                    </div>
                    <button class="cart-icon-btn" onclick="event.stopPropagation(); addToCart(${product.id}); updateCartCount();" title="ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€">ğŸ›’</button>
                `;
                fragment.appendChild(productCard);
            });

            productList.appendChild(fragment);
        }

        // Debounce í•¨ìˆ˜ - ê²€ìƒ‰ ì„±ëŠ¥ ìµœì í™”
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ê²€ìƒ‰ í•¨ìˆ˜ë¥¼ debounceë¡œ ê°ì‹¸ê¸°
        const debouncedSearch = debounce(function (searchTerm) {
            searchProducts(searchTerm);
        }, 300);

        // Search functionality
        document.getElementById('search-btn').addEventListener('click', function () {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            searchProducts(searchTerm);
        });

        document.getElementById('search-input').addEventListener('keyup', function (e) {
            const searchTerm = this.value.toLowerCase();
            if (e.key === 'Enter') {
                searchProducts(searchTerm);
            } else {
                // íƒ€ì´í•‘ ì¤‘ì—ëŠ” debounce ì ìš©
                debouncedSearch(searchTerm);
            }
        });

        function searchProducts(searchTerm) {
            if (!searchTerm) {
                renderProducts();
                return;
            }

            const productList = document.getElementById("product-list");
            const categoryTitle = document.getElementById("category-title");

            productList.innerHTML = "";

            // ë„ì–´ì“°ê¸° ì œê±°í•œ ë²„ì „ìœ¼ë¡œë„ ê²€ìƒ‰
            const searchTermNoSpace = searchTerm.replace(/\s/g, '');

            const filteredProducts = PRODUCTS.filter(product => {
                const nameNoSpace = product.name.replace(/\s/g, '').toLowerCase();
                const categoryNoSpace = product.category.replace(/\s/g, '').toLowerCase();

                return product.name.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm) ||
                    nameNoSpace.includes(searchTermNoSpace) ||
                    categoryNoSpace.includes(searchTermNoSpace);
            });

            categoryTitle.textContent = `ê²€ìƒ‰ ê²°ê³¼: "${searchTerm}"`;

            if (filteredProducts.length === 0) {
                productList.innerHTML = "<p style='text-align: center; padding: 2rem;'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            // ë¦¬ë·° ë°ì´í„°ë¥¼ í•œ ë²ˆì— ìºì‹±
            const reviewsCache = {};
            filteredProducts.forEach(product => {
                const reviews = JSON.parse(localStorage.getItem(`reviews_${product.id}`)) || [];
                reviewsCache[product.id] = {
                    count: reviews.length,
                    average: reviews.length > 0
                        ? (reviews.reduce((sum, review) => sum + review.rating, 0) / reviews.length).toFixed(1)
                        : 0
                };
            });

            // DocumentFragment ì‚¬ìš©ìœ¼ë¡œ DOM ì¡°ì‘ ìµœì í™”
            const fragment = document.createDocumentFragment();

            filteredProducts.forEach(product => {
                const reviewData = reviewsCache[product.id];

                const productCard = document.createElement("div");
                productCard.className = "product-card";
                productCard.onclick = function () { viewProduct(product.id); };
                productCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" loading="lazy">
                    <h3>${product.name}</h3>
                    <p>â‚©${product.price.toLocaleString()}</p>
                    <div class="product-review-info">
                        <span class="rating-stars">${'â­'.repeat(Math.round(reviewData.average))}</span>
                        <span class="rating-text">${reviewData.average} (${reviewData.count})</span>
                    </div>
                    <button class="cart-icon-btn" onclick="event.stopPropagation(); addToCart(${product.id}); updateCartCount();" title="ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€">ğŸ›’</button>
                `;
                fragment.appendChild(productCard);
            });

            productList.appendChild(fragment);
        }
    </script>
</body>

</html>