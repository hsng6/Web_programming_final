<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ìˆ– - AI ê°€ìƒ í”¼íŒ…ë£¸</title>
    <link rel="stylesheet" href="style.css">
    <!-- TensorFlow.js & PoseNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet@2.2.2/dist/posenet.min.js"></script>
</head>

<body>
    <header>
        <a href="index.html" class="logo">
            <h1>ì¸ìˆ–</h1>
        </a>
        <nav>
            <a href="index.html">í™ˆ</a>
            <a href="ai-fit.html">ğŸ¤– AI í•</a>
            <a href="virtual-fitting.html" class="highlight-link">ğŸ‘— ê°€ìƒ í”¼íŒ…</a>
            <a href="style-match.html" class="highlight-link">âœ¨ ìŠ¤íƒ€ì¼ ë§¤ì¹­</a>
            <a href="recommendations.html">âœ¨ ì¶”ì²œ</a>
            <a href="coupons.html">ğŸŸï¸ ì¿ í°</a>
            <a href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
            <a href="support.html">ê³ ê°ì„¼í„°</a>
            <a href="wishlist.html">â¤ï¸ ì°œ</a>
            <a href="cart.html">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</a>
            <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
        </nav>
    </header>

    <main class="virtual-fitting-container">
        <h2>ğŸ¨ AI ê°€ìƒ í”¼íŒ…ë£¸</h2>
        <p class="subtitle">ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´ AIê°€ ì²´í˜•ì„ ì¸ì‹í•˜ì—¬ ì˜·ì„ ì…í˜€ë“œë¦½ë‹ˆë‹¤!</p>

        <div class="fitting-workspace">
            <section class="upload-section">
                <h3>ğŸ“¸ ë‚´ ì‚¬ì§„ ì—…ë¡œë“œ</h3>
                <div class="upload-area">
                    <input type="file" id="user-photo" accept="image/*" style="display: none;">
                    <label for="user-photo" class="upload-label">
                        <div class="upload-icon">ğŸ“·</div>
                        <p>í´ë¦­í•˜ì—¬ ì‚¬ì§„ ì—…ë¡œë“œ</p>
                        <small>ì •ë©´ ì „ì‹  ì‚¬ì§„ ê¶Œì¥ (AIê°€ ì²´í˜•ì„ ì¸ì‹í•©ë‹ˆë‹¤)</small>
                    </label>
                    <div id="user-preview" class="photo-preview" style="display: none;">
                        <img id="user-image" src="" alt="User Photo">
                        <div id="pose-status" class="pose-status" style="display: none;"></div>
                        <button class="btn-change-photo" onclick="document.getElementById('user-photo').click()">ì‚¬ì§„
                            ë³€ê²½</button>
                    </div>
                </div>
            </section>

            <section class="product-selection">
                <h3>ğŸ‘” ì…ì–´ë³¼ ìƒí’ˆ ì„ íƒ</h3>
                <div class="products-carousel">
                    <button class="carousel-btn prev" onclick="scrollCarousel(-1)">â€¹</button>
                    <div id="fitting-products-list" class="carousel-items"></div>
                    <button class="carousel-btn next" onclick="scrollCarousel(1)">â€º</button>
                </div>
            </section>

            <section class="fitting-result">
                <h3>âœ¨ ê°€ìƒ í”¼íŒ… ê²°ê³¼</h3>
                <div class="result-display" id="result-display">
                    <div class="placeholder-message">
                        <p>ğŸ­</p>
                        <p>ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ê³  ìƒí’ˆì„ ì„ íƒí•˜ë©´</p>
                        <p>AIê°€ ê°€ìƒìœ¼ë¡œ ì˜·ì„ ì…í˜€ë“œë¦½ë‹ˆë‹¤!</p>
                    </div>
                    <div id="fitted-result" style="display: none;">
                        <div class="fitted-image-container">
                            <img id="fitted-image" src="" alt="Fitted Result">
                            <div class="product-overlay">
                                <h4 id="fitted-product-name"></h4>
                                <p id="fitted-product-price"></p>
                            </div>
                        </div>
                        <div class="result-actions">
                            <button class="btn-primary" onclick="addFittedToCart()">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</button>
                            <button class="btn-secondary" onclick="shareFitting()">ğŸ“¤ ê³µìœ </button>
                            <button class="btn-secondary" onclick="saveFitting()">ğŸ’¾ ì €ì¥</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <section class="fitting-history">
            <h3>ğŸ“‹ ë‚˜ì˜ í”¼íŒ… ê¸°ë¡</h3>
            <div id="history-list" class="history-grid"></div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 ì¸ìˆ–. All rights reserved.</p>
    </footer>

    <script src="main.js"></script>
    <script>
        let selectedProduct = null;
        let userPhoto = null;
        let poseNetModel = null;
        let bodyKeypoints = null;
        let bodySegments = null;

        // PoseNet ëª¨ë¸ ë¡œë“œ
        async function loadPoseNet() {
            if (!poseNetModel && typeof posenet !== 'undefined') {
                try {
                    console.log('PoseNet ëª¨ë¸ ë¡œë”© ì¤‘...');
                    poseNetModel = await posenet.load({
                        architecture: 'MobileNetV1',
                        outputStride: 16,
                        inputResolution: { width: 640, height: 480 },
                        multiplier: 0.75
                    });
                    console.log('âœ… PoseNet ë¡œë”© ì™„ë£Œ');
                    return poseNetModel;
                } catch (error) {
                    console.error('PoseNet ë¡œë”© ì‹¤íŒ¨:', error);
                    return null;
                }
            }
            return poseNetModel;
        }

        // ì²´í˜• í‚¤í¬ì¸íŠ¸ ê°ì§€
        async function detectBodyPose(imageElement) {
            try {
                const model = await loadPoseNet();
                if (!model) return null;

                const pose = await model.estimateSinglePose(imageElement, { flipHorizontal: false });
                return pose;
            } catch (error) {
                console.error('ì²´í˜• ì¸ì‹ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        // ì‹ ì²´ ì˜ì—­ ë¶„í• 
        function segmentBody(keypoints) {
            const parts = {};
            keypoints.forEach(kp => { parts[kp.part] = kp.position; });

            const torso = {
                top: Math.min(parts.leftShoulder?.y || 0, parts.rightShoulder?.y || 0),
                bottom: Math.max(parts.leftHip?.y || 0, parts.rightHip?.y || 0),
                left: Math.min(parts.leftShoulder?.x || 0, parts.leftHip?.x || 0) - 50,
                right: Math.max(parts.rightShoulder?.x || 0, parts.rightHip?.x || 0) + 50,
                centerX: ((parts.leftShoulder?.x || 0) + (parts.rightShoulder?.x || 0)) / 2,
                width: Math.abs((parts.rightShoulder?.x || 0) - (parts.leftShoulder?.x || 0))
            };

            const legs = {
                top: Math.min(parts.leftHip?.y || 0, parts.rightHip?.y || 0),
                bottom: Math.max(parts.leftAnkle?.y || 0, parts.rightAnkle?.y || 0),
                left: Math.min(parts.leftHip?.x || 0, parts.leftAnkle?.x || 0) - 30,
                right: Math.max(parts.rightHip?.x || 0, parts.rightAnkle?.x || 0) + 30,
                centerX: ((parts.leftHip?.x || 0) + (parts.rightHip?.x || 0)) / 2,
                width: Math.abs((parts.rightHip?.x || 0) - (parts.leftHip?.x || 0))
            };

            return { torso, legs, allParts: parts };
        }

        // ì‚¬ì§„ ì—…ë¡œë“œ
        document.getElementById('user-photo').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function (event) {
                userPhoto = event.target.result;
                const userImage = document.getElementById('user-image');
                userImage.src = userPhoto;
                document.getElementById('user-preview').style.display = 'block';
                document.querySelector('.upload-label').style.display = 'none';

                const poseStatus = document.getElementById('pose-status');
                poseStatus.style.display = 'block';
                poseStatus.innerHTML = '<div class="pose-loading">ğŸ¤– AIê°€ ì²´í˜•ì„ ë¶„ì„ì¤‘...</div>';

                userImage.onload = async function () {
                    const pose = await detectBodyPose(userImage);

                    if (pose && pose.score > 0.3) {
                        bodyKeypoints = pose.keypoints;
                        bodySegments = segmentBody(bodyKeypoints);

                        const confidence = Math.round(pose.score * 100);
                        poseStatus.innerHTML = `
                            <div class="pose-success">
                                âœ… ì²´í˜• ì¸ì‹ ì™„ë£Œ! (ì •í™•ë„: ${confidence}%)
                                <div class="body-measurements">
                                    <small>ì–´ê¹¨ ë„ˆë¹„: ${Math.round(bodySegments.torso.width)}px</small>
                                    <small>ìƒì²´: ${Math.round(bodySegments.torso.bottom - bodySegments.torso.top)}px</small>
                                    <small>í•˜ì²´: ${Math.round(bodySegments.legs.bottom - bodySegments.legs.top)}px</small>
                                </div>
                            </div>
                        `;
                    } else {
                        poseStatus.innerHTML = '<div class="pose-error">âš ï¸ ì²´í˜• ì¸ì‹ ì‹¤íŒ¨. ê¸°ë³¸ ëª¨ë“œë¡œ ì§„í–‰ë©ë‹ˆë‹¤.</div>';
                        bodyKeypoints = null;
                        bodySegments = null;
                    }

                    if (selectedProduct) generateFitting();
                };
            };
            reader.readAsDataURL(file);
        });

        // ìƒí’ˆ ëª©ë¡ ë¡œë“œ
        function loadFittingProducts() {
            console.log('=== loadFittingProducts ì‹œì‘ ===');

            if (typeof PRODUCTS === 'undefined') {
                console.error('âŒ PRODUCTS ì—†ìŒ');
                document.getElementById('fitting-products-list').innerHTML =
                    '<p style="color:red;padding:20px;">ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            console.log('âœ… PRODUCTS:', PRODUCTS.length + 'ê°œ');

            const productsList = document.getElementById('fitting-products-list');
            productsList.innerHTML = '';

            PRODUCTS.forEach((product) => {
                const card = document.createElement('div');
                card.className = 'fitting-product-card';
                card.onclick = () => selectProduct(product);
                card.innerHTML = `
                    <img src="${product.image}" alt="${product.name}">
                    <h4>${product.name}</h4>
                    <p class="price">â‚©${product.price.toLocaleString()}</p>
                `;
                productsList.appendChild(card);
            });

            console.log('âœ… ìƒí’ˆ ë¡œë“œ ì™„ë£Œ:', productsList.children.length + 'ê°œ');
        }

        // ìƒí’ˆ ì„ íƒ
        function selectProduct(product) {
            selectedProduct = product;
            document.querySelectorAll('.fitting-product-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.fitting-product-card').classList.add('selected');
            if (userPhoto) {
                generateFitting();
            } else {
                alert('ë¨¼ì € ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!');
            }
        }

        // ê°€ìƒ í”¼íŒ… ìƒì„±
        function generateFitting() {
            const resultDisplay = document.getElementById('result-display');
            const placeholder = resultDisplay.querySelector('.placeholder-message');
            const fitted = document.getElementById('fitted-result');

            placeholder.innerHTML = `
                <div class="loader-spinner"></div>
                <p>AIê°€ ì²´í˜•ì— ë§ì¶° ì˜·ì„ ì…íˆëŠ” ì¤‘...</p>
                <p>${bodySegments ? 'ğŸ¯ ì •ë°€ ë§¤í•‘ ëª¨ë“œ' : 'ğŸ“ ê¸°ë³¸ ë§¤í•‘ ëª¨ë“œ'}</p>
            `;

            setTimeout(() => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                const userImg = new Image();
                userImg.crossOrigin = "anonymous";
                userImg.onload = function () {
                    canvas.width = userImg.width;
                    canvas.height = userImg.height;
                    ctx.drawImage(userImg, 0, 0);

                    const productImg = new Image();
                    productImg.crossOrigin = "anonymous";
                    productImg.onload = function () {
                        if (bodySegments) {
                            applyPreciseFitting(ctx, productImg, canvas.width, canvas.height);
                        } else {
                            applyBasicFitting(ctx, productImg, canvas.width, canvas.height);
                        }

                        const fittedImageUrl = canvas.toDataURL('image/png', 1.0);
                        document.getElementById('fitted-image').src = fittedImageUrl;
                        document.getElementById('fitted-product-name').textContent = selectedProduct.name;
                        document.getElementById('fitted-product-price').textContent = `â‚©${selectedProduct.price.toLocaleString()}`;

                        placeholder.style.display = 'none';
                        fitted.style.display = 'block';

                        // ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì €ì¥
                        setTimeout(() => saveFittingHistory(fittedImageUrl), 100);
                    };
                    productImg.src = selectedProduct.image;
                };
                userImg.src = userPhoto;
            }, 2000);
        }

        // ì •ë°€ í”¼íŒ…
        function applyPreciseFitting(ctx, productImg, canvasWidth, canvasHeight) {
            const category = selectedProduct.category;

            if (category === 'TOPS' || category === 'OUTER') {
                const torso = bodySegments.torso;
                const targetWidth = torso.width * 2.2;
                const targetHeight = (torso.bottom - torso.top) * 1.1;
                const x = torso.centerX - targetWidth / 2;
                const y = torso.top - 20;

                ctx.globalCompositeOperation = 'multiply';
                ctx.globalAlpha = 0.75;
                ctx.drawImage(productImg, x, y, targetWidth, targetHeight);
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 0.9;
                ctx.drawImage(productImg, x, y, targetWidth, targetHeight);

            } else if (category === 'PANTS') {
                const legs = bodySegments.legs;
                const targetWidth = legs.width * 2.5;
                const targetHeight = (legs.bottom - legs.top) * 1.05;
                const x = legs.centerX - targetWidth / 2;
                const y = legs.top - 10;

                ctx.globalCompositeOperation = 'multiply';
                ctx.globalAlpha = 0.75;
                ctx.drawImage(productImg, x, y, targetWidth, targetHeight);
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 0.9;
                ctx.drawImage(productImg, x, y, targetWidth, targetHeight);

            } else if (category === 'SHOES') {
                const leftAnkle = bodySegments.allParts.leftAnkle;
                const rightAnkle = bodySegments.allParts.rightAnkle;

                if (leftAnkle && rightAnkle) {
                    const footWidth = Math.abs(rightAnkle.x - leftAnkle.x) * 1.5;
                    const footHeight = footWidth * 0.6;
                    const centerX = (leftAnkle.x + rightAnkle.x) / 2;
                    const y = Math.max(leftAnkle.y, rightAnkle.y) - footHeight * 0.3;
                    ctx.globalAlpha = 0.85;
                    ctx.drawImage(productImg, centerX - footWidth / 2, y, footWidth, footHeight);
                }
            } else {
                applyBasicFitting(ctx, productImg, canvasWidth, canvasHeight);
            }

            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1.0;
        }

        // ê¸°ë³¸ í”¼íŒ…
        function applyBasicFitting(ctx, productImg, canvasWidth, canvasHeight) {
            ctx.globalAlpha = 0.7;
            const scale = 0.5;
            const x = (canvasWidth - productImg.width * scale) / 2;
            const y = canvasHeight * 0.3;
            ctx.drawImage(productImg, x, y, productImg.width * scale, productImg.height * scale);
            ctx.globalAlpha = 1.0;
        }

        // í”¼íŒ… ê¸°ë¡ ì €ì¥
        function saveFittingHistory(fittedImageUrl) {
            const history = JSON.parse(localStorage.getItem('fittingHistory')) || [];

            // ì‹¤ì œ ìº”ë²„ìŠ¤ì— ì…í˜€ì§„ ì´ë¯¸ì§€ ì €ì¥
            const resultImage = fittedImageUrl || document.getElementById('fitted-image').src;

            const fitting = {
                id: Date.now(),
                productId: selectedProduct.id,
                productName: selectedProduct.name,
                productImage: selectedProduct.image,
                price: selectedProduct.price,
                userPhoto: userPhoto,
                result: resultImage, // ìº”ë²„ìŠ¤ì— ì˜·ì´ ì…í˜€ì§„ ì‹¤ì œ ì´ë¯¸ì§€
                category: selectedProduct.category,
                date: new Date().toLocaleDateString('ko-KR')
            };

            history.unshift(fitting);
            if (history.length > 10) history.pop();
            localStorage.setItem('fittingHistory', JSON.stringify(history));
            loadFittingHistory();

            console.log('âœ… í”¼íŒ… ê¸°ë¡ ì €ì¥ ì™„ë£Œ (ì‹¤ì œ ì…í˜€ì§„ ì´ë¯¸ì§€)');
        }

        // í”¼íŒ… ê¸°ë¡ ë¡œë“œ
        function loadFittingHistory() {
            const history = JSON.parse(localStorage.getItem('fittingHistory')) || [];
            const historyList = document.getElementById('history-list');

            if (history.length === 0) {
                historyList.innerHTML = '<p class="empty-message">ì•„ì§ í”¼íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            historyList.innerHTML = history.map(item => `
                <div class="history-item" onclick="viewFittingHistory(${item.id})">
                    <img src="${item.result}" alt="Fitting Result">
                    <div class="history-info">
                        <h5>${item.productName}</h5>
                        <p>${item.date}</p>
                    </div>
                </div>
            `).join('');
        }

        // ê¸°ë¡ ìƒì„¸ë³´ê¸°
        function viewFittingHistory(id) {
            const history = JSON.parse(localStorage.getItem('fittingHistory')) || [];
            const item = history.find(h => h.id === id);
            if (!item) return;

            document.getElementById('fitted-image').src = item.result;
            document.getElementById('fitted-product-name').textContent = item.productName;
            document.getElementById('fitted-product-price').textContent = `â‚©${item.price.toLocaleString()}`;
            document.querySelector('.placeholder-message').style.display = 'none';
            document.getElementById('fitted-result').style.display = 'block';
            selectedProduct = PRODUCTS.find(p => p.id === item.productId);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
        function addFittedToCart() {
            if (!selectedProduct) return;

            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const existing = cart.find(item => item.id === selectedProduct.id);

            if (existing) {
                existing.qty += 1;
            } else {
                cart.push({
                    id: selectedProduct.id,
                    name: selectedProduct.name,
                    price: selectedProduct.price,
                    image: selectedProduct.image,
                    qty: 1,
                    size: 'M'
                });
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            alert('ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ›’');
        }

        // ê³µìœ í•˜ê¸°
        function shareFitting() {
            navigator.clipboard.writeText(window.location.href);
            alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¤');
        }

        // ì €ì¥í•˜ê¸°
        function saveFitting() {
            const link = document.createElement('a');
            link.download = `fitting_${selectedProduct.name}_${Date.now()}.png`;
            link.href = document.getElementById('fitted-image').src;
            link.click();
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’¾');
        }

        // ìºëŸ¬ì…€ ìŠ¤í¬ë¡¤
        function scrollCarousel(direction) {
            document.getElementById('fitting-products-list').scrollBy({
                left: direction * 300,
                behavior: 'smooth'
            });
        }

        // í…Œë§ˆ
        function loadTheme() {
            const isDark = localStorage.getItem('theme') === 'dark';
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-toggle').textContent = 'â˜€ï¸';
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-toggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== ê°€ìƒ í”¼íŒ…ë£¸ ì´ˆê¸°í™” ===');
            loadTheme();
            loadFittingProducts();
            loadFittingHistory();
        });
    </script>
</body>

</html>