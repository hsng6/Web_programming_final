<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ìˆ– - ì£¼ë¬¸ë‚´ì—­</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <a href="index.html" class="logo">
            <h1>ì¸ìˆ–</h1>
        </a>
        <nav>
            <a href="index.html">í™ˆ</a>
            <a href="ai-fit.html" class="ai-fit-link">ğŸ¤– AI í•</a>
            <a href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
            <a href="orders.html">ì£¼ë¬¸ë‚´ì—­</a>
            <a href="support.html">ê³ ê°ì„¼í„°</a>
            <a href="wishlist.html" class="wishlist-link">â¤ï¸ ì°œ</a>
            <a href="cart.html" class="cart-link">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</a>
            <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
        </nav>
    </header>

    <main class="orders-container">
        <h2>ì£¼ë¬¸ë‚´ì—­</h2>

        <div class="orders-filter">
            <button class="filter-btn active" onclick="filterOrders('all')">ì „ì²´</button>
            <button class="filter-btn" onclick="filterOrders('ê²°ì œì™„ë£Œ')">ê²°ì œì™„ë£Œ</button>
            <button class="filter-btn" onclick="filterOrders('ìƒí’ˆì¤€ë¹„ì¤‘')">ìƒí’ˆì¤€ë¹„ì¤‘</button>
            <button class="filter-btn" onclick="filterOrders('ë°°ì†¡ì¤‘')">ë°°ì†¡ì¤‘</button>
            <button class="filter-btn" onclick="filterOrders('ë°°ì†¡ì™„ë£Œ')">ë°°ì†¡ì™„ë£Œ</button>
            <button class="filter-btn" onclick="filterOrders('cancelled')">ì·¨ì†Œ/í™˜ë¶ˆ</button>
        </div>

        <div id="orders-list">
            <!-- Orders will be loaded here -->
        </div>
    </main>

    <!-- ë°°ì†¡ ì¶”ì  ëª¨ë‹¬ -->
    <div id="tracking-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeTrackingModal()">&times;</span>
            <h2>ğŸšš ë°°ì†¡ ì¶”ì </h2>
            <div id="tracking-info">
                <div class="tracking-number">
                    <strong>ì†¡ì¥ë²ˆí˜¸:</strong> <span id="tracking-num">-</span>
                    <button onclick="copyTrackingNumber()" class="btn-copy">ë³µì‚¬</button>
                </div>
                <div class="tracking-company">
                    <strong>íƒë°°ì‚¬:</strong> <span id="courier-company">-</span>
                </div>
                <div class="tracking-timeline" id="tracking-timeline">
                    <!-- ë°°ì†¡ ë‹¨ê³„ í‘œì‹œ -->
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 ì¸ìˆ–. All rights reserved.</p>
    </footer>

    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
    <div id="toast" class="toast"></div>

    <script src="main.js"></script>
    <script>
        let currentFilter = 'all';

        function loadOrders() {
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            const ordersList = document.getElementById('orders-list');

            ordersList.innerHTML = '';

            if (orders.length === 0) {
                ordersList.innerHTML = '<p class="empty-message">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const filteredOrders = currentFilter === 'all'
                ? orders
                : orders.filter(order => {
                    // ìƒíƒœ ë§¤í•‘
                    if (currentFilter === 'ìƒí’ˆì¤€ë¹„ì¤‘') {
                        return order.status === 'ê²°ì œì™„ë£Œ' || order.status === 'pending' || order.status === 'processing';
                    } else if (currentFilter === 'ë°°ì†¡ì¤‘') {
                        return order.status === 'shipping';
                    } else if (currentFilter === 'ë°°ì†¡ì™„ë£Œ') {
                        return order.status === 'delivered';
                    } else if (currentFilter === 'ê²°ì œì™„ë£Œ') {
                        return order.status === 'ê²°ì œì™„ë£Œ' || order.status === 'pending';
                    }
                    return order.status === currentFilter;
                });

            if (filteredOrders.length === 0) {
                ordersList.innerHTML = '<p class="empty-message">í•´ë‹¹í•˜ëŠ” ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            filteredOrders.reverse().forEach((order, index) => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'order-card';

                const statusText = {
                    'ê²°ì œì™„ë£Œ': 'ìƒí’ˆì¤€ë¹„ì¤‘',
                    'pending': 'ìƒí’ˆì¤€ë¹„ì¤‘',
                    'processing': 'ìƒí’ˆì¤€ë¹„ì¤‘',
                    'shipping': 'ë°°ì†¡ì¤‘',
                    'delivered': 'ë°°ì†¡ì™„ë£Œ',
                    'cancelled': 'ì£¼ë¬¸ì·¨ì†Œ',
                    'refund_requested': 'í™˜ë¶ˆìš”ì²­',
                    'refunded': 'í™˜ë¶ˆì™„ë£Œ',
                    'exchange_requested': 'êµí™˜ìš”ì²­',
                    'exchanged': 'êµí™˜ì™„ë£Œ'
                };

                const itemsHtml = order.items.map(item => {
                    const quantity = item.quantity || item.qty || 1;
                    const price = item.price || 0;
                    const colorInfo = item.color ? `<span style="color: #667eea;">ìƒ‰ìƒ: ${item.color}</span>` : '';
                    const sizeInfo = item.size ? `<span>ì‚¬ì´ì¦ˆ: ${item.size}</span>` : '';
                    const options = [colorInfo, sizeInfo].filter(Boolean).join(' | ');

                    return `
                        <div class="order-item">
                            <img src="${item.image}" alt="${item.name}">
                            <div class="order-item-info">
                                <h4>${item.name}</h4>
                                ${options ? `<p style="font-size: 0.9em; color: #666;">${options}</p>` : ''}
                                <p>â‚©${price.toLocaleString()} Ã— ${quantity}</p>
                            </div>
                        </div>
                    `;
                }).join('');

                orderDiv.innerHTML = `
                    <div class="order-header">
                        <div class="order-date">${order.date}</div>
                        <div class="order-status status-${order.status}">${statusText[order.status] || 'ë°°ì†¡ì¤€ë¹„ì¤‘'}</div>
                    </div>
                    <div class="order-items">
                        ${itemsHtml}
                    </div>
                    <div class="order-footer">
                        <div class="order-total">ì´ ê²°ì œê¸ˆì•¡: â‚©${order.total.toLocaleString()}</div>
                        <div class="order-actions">
                            ${getOrderActions(order, orders.length - 1 - index)}
                        </div>
                    </div>
                `;

                ordersList.appendChild(orderDiv);
            });
        }

        function getOrderActions(order, index) {
            const status = order.status;
            let actions = `<button class="btn-detail" onclick="viewOrderDetail(${index})">ìƒì„¸ë³´ê¸°</button>`;

            // ë°°ì†¡ ì¶”ì  ë²„íŠ¼ (ë°°ì†¡ì¤‘, ë°°ì†¡ì™„ë£Œì¼ ë•Œ)
            if (status === 'ë°°ì†¡ì¤‘' || status === 'ë°°ì†¡ì™„ë£Œ' || status === 'shipping' || status === 'delivered') {
                actions += `<button class="btn-tracking" onclick="trackDelivery(${index})">ğŸšš ë°°ì†¡ì¶”ì </button>`;
            }

            if (status === 'ê²°ì œì™„ë£Œ' || status === 'ìƒí’ˆì¤€ë¹„ì¤‘' || status === 'pending') {
                actions += `<button class="btn-cancel" onclick="cancelOrder(${index})">ì£¼ë¬¸ì·¨ì†Œ</button>`;
            } else if (status === 'ë°°ì†¡ì™„ë£Œ' || status === 'delivered') {
                actions += `<button class="btn-exchange" onclick="requestExchange(${index})">êµí™˜ì‹ ì²­</button>`;
                actions += `<button class="btn-refund" onclick="requestRefund(${index})">í™˜ë¶ˆì‹ ì²­</button>`;
            } else if (status === 'ë°°ì†¡ì¤‘' || status === 'shipping') {
                actions += `<button class="btn-info" onclick="alert('ë°°ì†¡ì¤‘ì¸ ìƒí’ˆì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë ¹ í›„ êµí™˜/í™˜ë¶ˆ ì‹ ì²­í•´ì£¼ì„¸ìš”.')">ì·¨ì†Œë¶ˆê°€</button>`;
            }

            return actions;
        }

        function cancelOrder(index) {
            if (!confirm('ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            orders[index].status = 'cancelled';
            localStorage.setItem('orders', JSON.stringify(orders));

            alert('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadOrders();
        }

        function requestExchange(index) {
            const reason = prompt('êµí™˜ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');
            if (!reason) return;

            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            orders[index].status = 'exchange_requested';
            orders[index].exchangeReason = reason;
            orders[index].exchangeDate = new Date().toLocaleDateString();
            localStorage.setItem('orders', JSON.stringify(orders));

            alert('êµí™˜ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nê³ ê°ì„¼í„°ì—ì„œ í™•ì¸ í›„ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.');
            loadOrders();
        }

        function requestRefund(index) {
            const reason = prompt('í™˜ë¶ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');
            if (!reason) return;

            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            orders[index].status = 'refund_requested';
            orders[index].refundReason = reason;
            orders[index].refundDate = new Date().toLocaleDateString();
            localStorage.setItem('orders', JSON.stringify(orders));

            alert('í™˜ë¶ˆ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nê³ ê°ì„¼í„°ì—ì„œ í™•ì¸ í›„ í™˜ë¶ˆ ì²˜ë¦¬ë©ë‹ˆë‹¤.');
            loadOrders();
        }

        function filterOrders(status) {
            currentFilter = status;

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // cancelled í•„í„°ëŠ” ëª¨ë“  ì·¨ì†Œ/í™˜ë¶ˆ/êµí™˜ ìƒíƒœ í¬í•¨
            if (status === 'cancelled') {
                const orders = JSON.parse(localStorage.getItem('orders')) || [];
                const ordersList = document.getElementById('orders-list');
                ordersList.innerHTML = '';

                const cancelledOrders = orders.filter(order =>
                    ['cancelled', 'refund_requested', 'refunded', 'exchange_requested', 'exchanged'].includes(order.status)
                );

                if (cancelledOrders.length === 0) {
                    ordersList.innerHTML = '<p class="empty-message">ì·¨ì†Œ/í™˜ë¶ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                const statusText = {
                    'ê²°ì œì™„ë£Œ': 'ìƒí’ˆì¤€ë¹„ì¤‘',
                    'pending': 'ìƒí’ˆì¤€ë¹„ì¤‘',
                    'processing': 'ìƒí’ˆì¤€ë¹„ì¤‘',
                    'shipping': 'ë°°ì†¡ì¤‘',
                    'delivered': 'ë°°ì†¡ì™„ë£Œ',
                    'cancelled': 'ì£¼ë¬¸ì·¨ì†Œ',
                    'refund_requested': 'í™˜ë¶ˆìš”ì²­',
                    'refunded': 'í™˜ë¶ˆì™„ë£Œ',
                    'exchange_requested': 'êµí™˜ìš”ì²­',
                    'exchanged': 'êµí™˜ì™„ë£Œ'
                };

                cancelledOrders.reverse().forEach((order, idx) => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'order-card';

                    const itemsHtml = order.items.map(item => `
                        <div class="order-item">
                            <img src="${item.image}" alt="${item.name}">
                            <div class="order-item-info">
                                <h4>${item.name}</h4>
                                <p>â‚©${item.price.toLocaleString()} Ã— ${item.qty}</p>
                            </div>
                        </div>
                    `).join('');

                    const originalIndex = orders.indexOf(order);

                    orderDiv.innerHTML = `
                        <div class="order-header">
                            <div class="order-date">${order.date}</div>
                            <div class="order-status status-${order.status}">${statusText[order.status]}</div>
                        </div>
                        <div class="order-items">
                            ${itemsHtml}
                        </div>
                        <div class="order-footer">
                            <div class="order-total">ì´ ê²°ì œê¸ˆì•¡: â‚©${order.total.toLocaleString()}</div>
                            <div class="order-actions">
                                <button class="btn-detail" onclick="viewOrderDetail(${originalIndex})">ìƒì„¸ë³´ê¸°</button>
                            </div>
                        </div>
                    `;

                    ordersList.appendChild(orderDiv);
                });
                return;
            }

            loadOrders();
        }

        function viewOrderDetail(index) {
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            const order = orders[index];

            alert(`ì£¼ë¬¸ë²ˆí˜¸: ${index + 1}\nì£¼ë¬¸ì¼: ${order.date}\nìƒíƒœ: ${order.status}\nì´ì•¡: â‚©${order.total.toLocaleString()}`);
        }

        // Load theme on page load
        function loadTheme() {
            const isDark = localStorage.getItem('theme') === 'dark';
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-toggle').textContent = 'â˜€ï¸';
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-toggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // ë°°ì†¡ ì¶”ì  ê¸°ëŠ¥
        function trackDelivery(index) {
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            const order = orders[index];

            // ë°°ì†¡ ì •ë³´ê°€ ì—†ìœ¼ë©´ ìƒì„±
            if (!order.tracking) {
                order.tracking = generateTrackingInfo(order);
                orders[index] = order;
                localStorage.setItem('orders', JSON.stringify(orders));
            }

            showTrackingModal(order);
        }

        function generateTrackingInfo(order) {
            const couriers = ['CJëŒ€í•œí†µìš´', 'ìš°ì²´êµ­íƒë°°', 'ë¡œì  íƒë°°', 'í•œì§„íƒë°°', 'GSíƒë°°'];
            const randomCourier = couriers[Math.floor(Math.random() * couriers.length)];
            const trackingNumber = generateTrackingNumber();

            return {
                courier: randomCourier,
                trackingNumber: trackingNumber,
                shippedDate: new Date().toLocaleDateString(),
                estimatedDelivery: getEstimatedDelivery()
            };
        }

        function generateTrackingNumber() {
            // ì†¡ì¥ë²ˆí˜¸ í˜•ì‹: 1234-5678-9012
            const part1 = Math.floor(1000 + Math.random() * 9000);
            const part2 = Math.floor(1000 + Math.random() * 9000);
            const part3 = Math.floor(1000 + Math.random() * 9000);
            return `${part1}-${part2}-${part3}`;
        }

        function getEstimatedDelivery() {
            const today = new Date();
            today.setDate(today.getDate() + Math.floor(1 + Math.random() * 2)); // 1-2ì¼ í›„
            return today.toLocaleDateString();
        }

        function showTrackingModal(order) {
            const modal = document.getElementById('tracking-modal');
            const trackingNum = document.getElementById('tracking-num');
            const courierCompany = document.getElementById('courier-company');
            const trackingTimeline = document.getElementById('tracking-timeline');

            trackingNum.textContent = order.tracking.trackingNumber;
            courierCompany.textContent = order.tracking.courier;

            // ë°°ì†¡ ë‹¨ê³„ íƒ€ì„ë¼ì¸
            const steps = getDeliverySteps(order);
            trackingTimeline.innerHTML = steps.map((step, index) => `
                <div class="timeline-step ${step.completed ? 'completed' : ''} ${step.current ? 'current' : ''}">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <div class="timeline-title">${step.title}</div>
                        <div class="timeline-date">${step.date || ''}</div>
                        <div class="timeline-description">${step.description || ''}</div>
                    </div>
                </div>
            `).join('');

            modal.style.display = 'flex';
        }

        function getDeliverySteps(order) {
            const status = order.status;
            const orderDate = order.date;
            const shippedDate = order.tracking?.shippedDate || '';
            const estimatedDate = order.tracking?.estimatedDelivery || '';

            const steps = [
                {
                    title: 'ì£¼ë¬¸ì™„ë£Œ',
                    date: orderDate,
                    description: 'ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤',
                    completed: true,
                    current: status === 'ê²°ì œì™„ë£Œ'
                },
                {
                    title: 'ìƒí’ˆì¤€ë¹„',
                    date: status !== 'ê²°ì œì™„ë£Œ' ? orderDate : '',
                    description: 'ìƒí’ˆì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤',
                    completed: status !== 'ê²°ì œì™„ë£Œ',
                    current: status === 'ìƒí’ˆì¤€ë¹„ì¤‘'
                },
                {
                    title: 'ë°°ì†¡ì¤‘',
                    date: (status === 'ë°°ì†¡ì¤‘' || status === 'ë°°ì†¡ì™„ë£Œ') ? shippedDate : '',
                    description: (status === 'ë°°ì†¡ì¤‘' || status === 'ë°°ì†¡ì™„ë£Œ') ? 'ìƒí’ˆì´ ë°°ì†¡ ì¤‘ì…ë‹ˆë‹¤' : '',
                    completed: status === 'ë°°ì†¡ì¤‘' || status === 'ë°°ì†¡ì™„ë£Œ' || status === 'shipping' || status === 'delivered',
                    current: status === 'ë°°ì†¡ì¤‘' || status === 'shipping'
                },
                {
                    title: 'ë°°ì†¡ì™„ë£Œ',
                    date: status === 'ë°°ì†¡ì™„ë£Œ' || status === 'delivered' ? estimatedDate : '',
                    description: status === 'ë°°ì†¡ì™„ë£Œ' || status === 'delivered' ? 'ë°°ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤' : `ì˜ˆìƒ ë„ì°©ì¼: ${estimatedDate}`,
                    completed: status === 'ë°°ì†¡ì™„ë£Œ' || status === 'delivered',
                    current: status === 'ë°°ì†¡ì™„ë£Œ' || status === 'delivered'
                }
            ];

            return steps;
        }

        function closeTrackingModal() {
            document.getElementById('tracking-modal').style.display = 'none';
        }

        function copyTrackingNumber() {
            const trackingNum = document.getElementById('tracking-num').textContent;
            navigator.clipboard.writeText(trackingNum).then(() => {
                alert('ì†¡ì¥ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ' + trackingNum);
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            // ë¡œê·¸ì¸ ì²´í¬
            if (!requireLogin('ì£¼ë¬¸ë‚´ì—­ì€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.')) {
                return;
            }

            loadTheme();
            loadOrders();

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            window.onclick = function (event) {
                const modal = document.getElementById('tracking-modal');
                if (event.target === modal) {
                    closeTrackingModal();
                }
            };
        });
    </script>
</body>

</html>