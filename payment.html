<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¸ìˆ™ - ê²°ì œ</title>
  <link rel="stylesheet" href="style.css">
  <!-- í† ìŠ¤í˜ì´ë¨¼ì¸  SDK -->
  <script src="https://js.tosspayments.com/v1/payment-widget"></script>
</head>

<body>
  <header>
    <a href="index.html" class="logo">
      <h1>ì¸ìˆ–</h1>
    </a>
    <nav>
      <a href="index.html">í™ˆ</a>
      <a href="ai-fit.html" class="ai-fit-link">ğŸ¤– AI í•</a>
      <a href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
      <a href="orders.html">ì£¼ë¬¸ë‚´ì—­</a>
      <a href="support.html">ê³ ê°ì„¼í„°</a>
      <a href="wishlist.html" class="wishlist-link">â¤ï¸ ì°œ</a>
      <a href="cart.html" class="cart-link">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</a>
      <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
    </nav>
  </header>
  <main>
    <section id="payment">
      <h2>ê²°ì œ ì •ë³´</h2>

      <!-- Order Summary -->
      <div class="order-summary">
        <h3>ì£¼ë¬¸ ìƒí’ˆ</h3>
        <div id="order-items"></div>
        <div class="price-details">
          <div class="price-row">
            <span>ìƒí’ˆ ê¸ˆì•¡</span>
            <span id="subtotal">â‚©0</span>
          </div>
          <div class="price-row">
            <span>ë°°ì†¡ë¹„</span>
            <span>â‚©3,000</span>
          </div>
          <div class="price-row discount-row" id="discount-row" style="display: none;">
            <span>í• ì¸ ê¸ˆì•¡</span>
            <span id="discount-amount">-â‚©0</span>
          </div>
          <div class="price-row total-row">
            <span>ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
            <span id="final-total">â‚©0</span>
          </div>
        </div>
      </div>

      <!-- Coupon Section -->
      <div class="coupon-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3>ğŸŸï¸ ì¿ í° / í• ì¸ì½”ë“œ</h3>
          <a href="coupons.html" class="btn-view-coupons">ë‚´ ì¿ í°í•¨ ë³´ê¸° â†’</a>
        </div>
        <div id="user-coupons-list" class="user-coupons-list">
          <!-- Available coupons will be loaded here -->
        </div>
        <div class="coupon-input-group">
          <input type="text" id="coupon-code" placeholder="ì¿ í° ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
          <button type="button" onclick="applyCoupon()">ì ìš©</button>
        </div>
      </div>

      <form id="payment-form">
        <h3>ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ</h3>
        <div class="payment-methods">
          <label class="payment-method-option">
            <input type="radio" name="payment-method" value="ì¹´ë“œ" checked>
            <span>ğŸ’³ ì‹ ìš©/ì²´í¬ì¹´ë“œ</span>
          </label>
          <label class="payment-method-option">
            <input type="radio" name="payment-method" value="ê³„ì¢Œì´ì²´">
            <span>ğŸ¦ ê³„ì¢Œì´ì²´</span>
          </label>
          <label class="payment-method-option">
            <input type="radio" name="payment-method" value="ê°€ìƒê³„ì¢Œ">
            <span>ğŸ’µ ê°€ìƒê³„ì¢Œ</span>
          </label>
          <label class="payment-method-option">
            <input type="radio" name="payment-method" value="í† ìŠ¤í˜ì´">
            <span>ğŸ³ í† ìŠ¤í˜ì´</span>
          </label>
        </div>

        <h3>ë°°ì†¡ ì •ë³´</h3>
        <label for="recipient-name">ë°›ëŠ” ì‚¬ëŒ:</label>
        <input type="text" id="recipient-name" required>

        <label for="phone">ì—°ë½ì²˜:</label>
        <input type="tel" id="phone" placeholder="010-0000-0000" required>

        <label for="address">ë°°ì†¡ì§€ ì£¼ì†Œ:</label>
        <input type="text" id="address" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" required>

        <label for="delivery-message">ë°°ì†¡ ë©”ëª¨ (ì„ íƒ):</label>
        <input type="text" id="delivery-message" placeholder="ë°°ì†¡ ì‹œ ìš”ì²­ì‚¬í•­">

        <button type="submit">ê²°ì œí•˜ê¸°</button>
      </form>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 ì¸ìˆ–. All rights reserved.</p>
  </footer>

  <script src="main.js"></script>
  <script>
    let appliedCoupon = null;
    let discountAmount = 0;
    let freeShipping = false;

    function loadOrderSummary() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const orderItems = document.getElementById('order-items');

      // ê°€ê²© ì •ë³´ê°€ ì—†ëŠ” ìƒí’ˆë“¤ ë³´ì •
      const fixedCart = cart.map(item => {
        if (!item.price || item.price === 0) {
          const product = PRODUCTS.find(p => p.id === item.id);
          if (product) {
            return { ...item, price: product.price, image: product.image || item.image };
          }
        }
        return item;
      });

      // ìˆ˜ì •ëœ ì¥ë°”êµ¬ë‹ˆ ì €ì¥
      localStorage.setItem('cart', JSON.stringify(fixedCart));

      orderItems.innerHTML = fixedCart.map(item => {
        const quantity = item.quantity || item.qty || 1;
        const price = item.price || 0;
        const colorInfo = item.color ? ` [${item.color}]` : '';
        const sizeInfo = item.size ? ` (${item.size})` : '';

        return `
          <div class="order-item-row">
            <span>${item.name}${colorInfo}${sizeInfo} Ã— ${quantity}</span>
            <span>â‚©${(price * quantity).toLocaleString()}</span>
          </div>
        `;
      }).join('');

      calculateTotal();
    }

    function calculateTotal() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const subtotal = cart.reduce((sum, item) => {
        const quantity = item.quantity || item.qty || 1;
        const price = item.price || 0;
        return sum + (price * quantity);
      }, 0);
      const shipping = freeShipping ? 0 : 3000;
      const finalTotal = subtotal + shipping - discountAmount;

      document.getElementById('subtotal').textContent = `â‚©${subtotal.toLocaleString()}`;
      document.getElementById('final-total').textContent = `â‚©${finalTotal.toLocaleString()}`;
    }

    function loadUserCoupons() {
      const coupons = JSON.parse(localStorage.getItem('userCoupons')) || [];
      const today = new Date();
      const availableCoupons = coupons.filter(c => !c.used && new Date(c.expiryDate) >= today);

      const container = document.getElementById('user-coupons-list');
      container.innerHTML = '';

      if (availableCoupons.length === 0) {
        container.innerHTML = '<p class="no-coupons">ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤. <a href="coupons.html">ì¿ í°í•¨ì—ì„œ ì¶”ê°€í•˜ê¸°</a></p>';
        return;
      }

      availableCoupons.forEach(coupon => {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const subtotal = cart.reduce((sum, item) => {
          const quantity = item.quantity || item.qty || 1;
          const price = item.price || 0;
          return sum + (price * quantity);
        }, 0);

        const canUse = subtotal >= coupon.minPurchase;
        const discountText = coupon.type === 'fixed' ? `${coupon.discount.toLocaleString()}ì›` : `${coupon.discount}%`;

        const couponItem = document.createElement('div');
        couponItem.className = `coupon-item ${!canUse ? 'disabled' : ''}`;
        couponItem.innerHTML = `
          <div class="coupon-item-info">
            <span class="coupon-discount">${discountText}</span>
            <span class="coupon-name">${coupon.name}</span>
            <span class="coupon-condition">${coupon.minPurchase.toLocaleString()}ì› ì´ìƒ êµ¬ë§¤ ì‹œ</span>
          </div>
          <button class="btn-apply-coupon" onclick="applyCouponByCode('${coupon.code}')" ${!canUse ? 'disabled' : ''}>ì ìš©</button>
        `;
        container.appendChild(couponItem);
      });
    }

    function applyCouponByCode(code) {
      document.getElementById('coupon-code').value = code;
      applyCoupon();
    }

    function applyCoupon() {
      const couponCode = document.getElementById('coupon-code').value.trim().toUpperCase();
      const cart = JSON.parse(localStorage.getItem('cart')) || [];

      if (!couponCode) {
        alert('ì¿ í° ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }

      const subtotalCalculated = cart.reduce((sum, item) => {
        const quantity = item.quantity || item.qty || 1;
        const price = item.price || 0;
        return sum + (price * quantity);
      }, 0);

      // ì‚¬ìš©ì ì¿ í°í•¨ì—ì„œ ì¿ í° ì°¾ê¸°
      const coupons = JSON.parse(localStorage.getItem('userCoupons')) || [];
      const coupon = coupons.find(c => c.code === couponCode && !c.used);

      let discount = 0;
      let message = '';
      freeShipping = false;

      if (coupon) {
        // ìœ íš¨ê¸°ê°„ í™•ì¸
        if (new Date(coupon.expiryDate) < new Date()) {
          alert('ë§Œë£Œëœ ì¿ í°ì…ë‹ˆë‹¤.');
          return;
        }

        // ìµœì†Œ êµ¬ë§¤ ê¸ˆì•¡ í™•ì¸
        if (subtotalCalculated < coupon.minPurchase) {
          alert(`ì´ ì¿ í°ì€ ${coupon.minPurchase.toLocaleString()}ì› ì´ìƒ êµ¬ë§¤ ì‹œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
          return;
        }

        if (coupon.type === 'fixed') {
          discount = coupon.discount;
        } else if (coupon.type === 'percent') {
          discount = Math.floor(subtotalCalculated * (coupon.discount / 100));
        }

        message = `${coupon.name} ì¿ í°ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!`;
        appliedCoupon = couponCode;
      } else {
        alert('ìœ íš¨í•˜ì§€ ì•Šì€ ì¿ í° ì½”ë“œì…ë‹ˆë‹¤.');
        return;
      }

      discountAmount = discount;

      if (discount > 0) {
        document.getElementById('discount-row').style.display = 'flex';
        document.getElementById('discount-amount').textContent = `-â‚©${discount.toLocaleString()}`;
      }

      calculateTotal();
      alert(message);
      document.getElementById('coupon-code').disabled = true;

      // ì¿ í° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      loadUserCoupons();
    }

    document.getElementById('payment-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const cart = JSON.parse(localStorage.getItem('cart')) || [];

      if (cart.length === 0) {
        alert('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');
        window.location.href = 'index.html';
        return;
      }

      // ì¬ê³  í™•ì¸
      for (const item of cart) {
        if (window.checkStock && !window.checkStock(item.id, item.size, item.quantity || item.qty || 1)) {
          alert(`${item.name} (ì‚¬ì´ì¦ˆ: ${item.size})ì˜ ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ì¥ë°”êµ¬ë‹ˆë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
          return;
        }
      }

      // ë°°ì†¡ ì •ë³´ ìˆ˜ì§‘
      const recipientName = document.getElementById('recipient-name').value;
      const phone = document.getElementById('phone').value;
      const address = document.getElementById('address').value;
      const deliveryMessage = document.getElementById('delivery-message').value;
      const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;

      if (!recipientName || !phone || !address) {
        alert('ë°°ì†¡ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }

      const subtotal = cart.reduce((sum, item) => {
        const quantity = item.quantity || item.qty || 1;
        const price = item.price || 0;
        return sum + (price * quantity);
      }, 0);
      const shipping = freeShipping ? 0 : 3000;
      const total = subtotal + shipping - discountAmount;

      // ê²°ì œ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œë¡œëŠ” í† ìŠ¤í˜ì´ë¨¼ì¸  API í˜¸ì¶œ)
      const paymentSuccess = await simulatePayment(paymentMethod, total);

      if (!paymentSuccess.success) {
        // ê²°ì œ ì‹¤íŒ¨
        window.location.href = `payment-failure.html?reason=${encodeURIComponent(paymentSuccess.reason)}&code=${paymentSuccess.code}`;
        return;
      }

      // ì¬ê³  ì°¨ê°
      cart.forEach(item => {
        const quantity = item.quantity || item.qty || 1;
        if (window.updateProductStock) {
          window.updateProductStock(item.id, item.size, quantity, item.color);
        }
      });

      // ì£¼ë¬¸ ìƒì„±
      const orderId = 'ORD-' + Date.now();
      const order = {
        orderId: orderId,
        items: cart,
        subtotal: subtotal,
        shipping: shipping,
        discount: discountAmount,
        coupon: appliedCoupon,
        total: total,
        paymentMethod: paymentMethod,
        recipient: {
          name: recipientName,
          phone: phone,
          address: address,
          message: deliveryMessage
        },
        date: new Date().toLocaleDateString('ko-KR'),
        dateTime: new Date().toISOString(),
        status: 'ê²°ì œì™„ë£Œ'
      };

      // ì¿ í° ì‚¬ìš© ì²˜ë¦¬
      if (appliedCoupon) {
        const coupons = JSON.parse(localStorage.getItem('userCoupons')) || [];
        const couponIndex = coupons.findIndex(c => c.code === appliedCoupon);
        if (couponIndex !== -1) {
          coupons[couponIndex].used = true;
          coupons[couponIndex].usedDate = new Date().toISOString();
          localStorage.setItem('userCoupons', JSON.stringify(coupons));
        }
      }

      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      orders.push(order);
      localStorage.setItem('orders', JSON.stringify(orders));

      localStorage.removeItem('cart');

      // ê²°ì œ ì„±ê³µ í˜ì´ì§€ë¡œ ì´ë™
      window.location.href = `payment-success.html?orderId=${orderId}&paymentMethod=${encodeURIComponent(paymentMethod)}&amount=${total}`;
    });

    // ê²°ì œ ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜ (ì‹¤ì œë¡œëŠ” í† ìŠ¤í˜ì´ë¨¼ì¸  API í˜¸ì¶œ)
    async function simulatePayment(method, amount) {
      // ê²°ì œ ì²˜ë¦¬ ì‹œë®¬ë ˆì´ì…˜ (2ì´ˆ ëŒ€ê¸°)
      await new Promise(resolve => setTimeout(resolve, 2000));

      // 10% í™•ë¥ ë¡œ ê²°ì œ ì‹¤íŒ¨ ì‹œë®¬ë ˆì´ì…˜
      const random = Math.random();
      if (random < 0.1) {
        return {
          success: false,
          reason: 'ì¹´ë“œ ìŠ¹ì¸ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´ë“œì‚¬ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.',
          code: 'CARD_DECLINED'
        };
      }

      // ê²°ì œ ì„±ê³µ
      return {
        success: true,
        transactionId: 'TXN-' + Date.now(),
        method: method,
        amount: amount
      };
    }

    // Load theme on page load
    function loadTheme() {
      const isDark = localStorage.getItem('theme') === 'dark';
      if (isDark) {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-toggle').textContent = 'â˜€ï¸';
      }
    }

    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      document.getElementById('theme-toggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    document.addEventListener('DOMContentLoaded', function () {
      // ë¡œê·¸ì¸ ì²´í¬
      if (!requireLogin('ê²°ì œëŠ” ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.')) {
        return;
      }

      loadTheme();
      loadOrderSummary();
      loadUserCoupons();
    });
  </script>
</body>

</html>